<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>訪問看護・介護スケジュール（デモ版）</title>
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<style>
  :root{
    --brand:#2F7DF6; --brand-2:#6BB6FF; --bg:#F6FAFF; --panel:#FFFFFF; --line:#D9E7FB;
    --text:#0C1B2A; --muted:#6E7F95; --chip:#EEF6FF; --danger:#E05252; --ok:#2FBF71;
    --event-border:rgba(0,0,0,.12); --modal-shadow:0 10px 30px rgba(0,0,0,.25);
    --cta:#FFD66B; --cta-text:#583400;
  }
  body{font-family:'Noto Sans JP',system-ui,sans-serif;margin:0;background:var(--bg);color:var(--text)}
  header{
    background:linear-gradient(90deg,var(--brand),var(--brand-2));
    color:#fff;padding:10px 16px;
    display:flex;flex-direction:column;align-items:flex-start;gap:6px;position:sticky;top:0;z-index:5;
  }
  header h1{margin:0;font-size:1.06rem;letter-spacing:.2px}
  header .btns{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px;width:100%}
  header .btns button{
    height:36px;line-height:36px;border-radius:10px;padding:0 10px;
    border:1px solid rgba(255,255,255,.85);background:rgba(255,255,255,.12);
    color:#fff;font-weight:800;cursor:pointer;box-shadow:0 1px 3px rgba(0,0,0,.15);transition:.15s ease;
  }
  header .btns button:hover{background:rgba(255,255,255,.22);transform:translateY(-1px);}
  #btnHelp{background:#fff;color:#174D9E;border-color:#fff}

  /* 常にサイドバー左・カレンダー右（※狭い画面のみ縦） */
  .layout{display:grid;grid-template-columns:380px 1fr;gap:12px;min-height:calc(100vh - 108px);padding:12px;box-sizing:border-box}
  @media (max-width:768px){ .layout{grid-template-columns:1fr;min-height:auto} aside{order:2} main{order:1} }
  aside,main{background:var(--panel);border-radius:14px;overflow:auto;border:1px solid var(--line)}
  aside{padding:14px;position:relative}
  main{padding:6px}
  h3{margin:8px 0;font-size:1rem}
  label{display:block;margin:6px 0 4px;font-weight:700}
  input,select,button,textarea{width:100%;padding:11px;border:1px solid var(--line);border-radius:10px;box-sizing:border-box;font-size:1rem}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .chip{background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:6px 10px;display:flex;align-items:center;gap:8px}
  aside .row>button{background:var(--brand);color:#fff;border-color:var(--brand);font-weight:800;box-shadow:0 1px 4px rgba(47,125,246,.18)}
  .chip>button{padding:6px 10px;border-radius:999px;font-weight:800}
  .chip .ghost{background:#fff;color:var(--brand);border:1px solid var(--brand)}
  .chip .danger{background:var(--danger);color:#fff;border:1px solid var(--danger)}
  .sticky-bottom .primary{background:linear-gradient(180deg,var(--brand-2),var(--brand));border-color:var(--brand);color:#fff;box-shadow:0 2px 8px rgba(47,125,246,.28)}

  #calendar{min-height:78vh}

  /* イベント視認性 */
  .fc-v-event{
    border:2px solid var(--event-border);border-radius:12px;padding:4px 6px;
    font-weight:800;overflow:hidden;white-space:nowrap;box-shadow:0 2px 8px rgba(0,0,0,.15);
    opacity:.98; color:#111; text-shadow:0 1px 0 rgba(255,255,255,.45);
  }
  .fc-v-event:hover{filter:brightness(1.04);transform:translateY(-1px);transition:.15s}

  /* モーダル */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:999}
  .modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:14px;box-shadow:var(--modal-shadow);padding:16px;z-index:1000;min-width:360px;max-width:92vw;border:1px solid var(--line);max-height:80vh;overflow:auto}
  .modal h3{margin-top:0}
  .actions{display:flex;gap:8px;margin-top:10px}
  .btn{padding:10px 12px;border-radius:10px;border:1px solid var(--line);cursor:pointer;font-weight:800}
  .btn.primary{background:linear-gradient(180deg,var(--brand-2),var(--brand));color:#fff;border-color:var(--brand)}
  .btn.danger{background:var(--danger);color:#fff;border-color:var(--danger)}
  .btn.ghost{background:#fff;color:var(--brand);border-color:var(--brand)}

  /* スタッフ別ボード */
  #staffBoard{display:none;gap:10px}
  #staffBoard.active{display:grid}
  #staffBoard .col{min-width:280px;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#fff}
  #staffBoard .col h4{margin:0;padding:8px 10px;background:#f0f6ff;border-bottom:1px solid var(--line)}
  #staffBoard .calHost{padding:6px}
  #staffBoardControls{display:none;gap:8px;align-items:center;margin:6px 0;}
  #staffBoardControls.active{display:flex;}

  /* 印刷ビュー（デモでは案内のみ） */
  #printView{display:none;background:#fff;padding:12px;}

  /* もっと見る */
  .list-collapsed{max-height:140px;overflow:hidden;position:relative}
  .list-collapsed::after{content:"";position:absolute;left:0;right:0;bottom:0;height:48px;background:linear-gradient(to bottom, rgba(255,255,255,0), var(--panel));pointer-events:none}
  .show-more-btn{margin-top:6px;width:100%;background:var(--chip);border:1px solid var(--line);border-radius:10px;padding:8px 10px;font-weight:800;color:var(--text);cursor:pointer;display:block}
  .show-more-btn:hover{filter:brightness(1.03)}

  /* チュートリアル帯 */
  .tutor{
    background:var(--cta); color:var(--cta-text);
    border:1px solid #e6b84a; border-radius:12px; padding:10px 12px; font-weight:800; margin-bottom:10px;
  }

  /* サイドバーON/OFF（残し） */
  body.sidebar-collapsed .layout{grid-template-columns:1fr!important}
  body.sidebar-collapsed aside{display:none!important}
  body.edge-to-edge .layout{padding:0!important}
  body.edge-to-edge main{padding:0!important;border:none!important;border-radius:0!important}
</style>
</head>

<body class="edge-to-edge">
<header>
  <h1>訪問看護・介護スケジュール（デモ版）</h1>
  <div class="btns">
    <button id="btnResetWeek">今週分を消去（デモ表示・保存済み新規も削除）</button>
    <button id="btnPrintCurrentA4">A4印刷（デモでは不可）</button>
    <button id="btnToggleSidebar">サイドバー ON/OFF</button>
    <button id="btnViewToggle" title="標準カレンダー／スタッフ別ボード">表示：標準</button>
    <button id="btnHelp">❓ ヘルプ / 商品説明</button>
  </div>
</header>

<div class="layout">
  <aside>
    <!-- チュートリアル帯 -->
    <div class="tutor">
      まずは「自動割当（デモ）」を押して、シフト作成の速さを体験してください！<br>
      ※ デモでは<strong>新規イベントの追加のみ保存</strong>されます。他の操作は表示のみです。
    </div>

    <h3>拠点（事務所）</h3>
    <div class="row">
      <input id="officeAddress" placeholder="（デモ）大阪市○○区△△町 1-2-3" value="（デモ）大阪市中央区架空町 1-2-3">
      <button id="btnSaveOffice">拠点保存（デモでは不可）</button>
    </div>
    <div id="officeInfo" class="muted" style="font-size:.92rem">デモ用：上の住所は変更できますが保存はされません</div>

    <h3>スタッフ登録</h3>
    <div class="row">
      <input id="staffName" placeholder="氏名（例：佐藤）" />
      <select id="staffType" style="max-width:120px"><option value="FT">常勤</option><option value="PT">非常勤</option></select>
    </div>
    <div class="row"><button id="addStaff">追加（デモでは不可）</button></div>
    <div id="staffList" class="chips"></div>

    <h3>出勤パターン（複数帯OK）</h3>
    <label>スタッフ</label><select id="shiftStaff"></select>
    <label>曜日</label><div id="shiftDays" class="row"></div>
    <label>勤務時間</label>
    <div class="row"><input id="shiftStart" type="time" value="09:00" style="flex:1"><input id="shiftEnd" type="time" value="18:00" style="flex:1"></div>
    <div class="row"><button id="addShift">出勤パターン追加（デモでは不可）</button></div>
    <div id="shiftList" class="chips"></div>

    <h3>利用者登録</h3>
    <div class="row">
      <input id="userName" placeholder="利用者氏名（例：田中）" />
      <select id="userDuration" style="max-width:120px"><option value="60">60分</option><option value="30">30分</option></select>
    </div>
    <input id="userAddress" placeholder="住所（任意）" />
    <div class="row"><button id="addUser">追加（デモでは不可）</button></div>
    <div id="userList" class="chips"></div>

    <h3>基本訪問パターン</h3>
    <label>利用者</label><select id="patternUser"></select>
    <label>曜日</label><div id="patternDays" class="row"></div>
    <label>開始時刻</label><input id="patternTime" type="time" value="14:00" />
    <div class="row"><button id="addPattern">パターン追加（デモでは不可）</button></div>
    <div id="patternList" class="chips"></div>

    <h3>NG設定（スタッフ別・複数選択）</h3>
    <label>スタッフ</label><select id="ngStaff"></select>
    <label>NGにする利用者（複数選択可）</label>
    <div id="ngUsers" class="row" style="max-height:140px; overflow:auto; border:1px dashed var(--line); padding:8px; border-radius:10px"></div>
    <div class="row"><button id="btnAddNG">NG追加（デモでは不可）</button></div>

    <div class="sticky-bottom">
      <button id="btnAutoAssignBottom" class="primary">自動割当（デモ）</button>
    </div>
  </aside>

  <main>
    <div id="calendar"></div>

    <div id="staffBoardControls">
      <button id="sbPrev">◀ 前日</button>
      <input id="sbDate" type="date" style="max-width:180px">
      <button id="sbNext">翌日 ▶</button>
    </div>
    <div id="staffBoard" class="grid" style="grid-template-columns: repeat(auto-fit,minmax(280px,1fr));"></div>

    <div id="printView"></div>
  </main>
</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{
  // ====== デモ設定 ======
  const DEMO = true;
  const EVENTS_KEY='vk_demo_events_v2'; // 新規追加イベントのみ保存するためのキー
  const jp=['日','月','火','水','木','金','土'];
  const dayNamesJP=['月','火','水','木','金','土','日'];

  // === 便利関数 ===
  const fmtDateLocal=(d)=>{const y=d.getFullYear();const m=String(d.getMonth()+1).padStart(2,'0');const da=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${da}`;};
  const addMinStr=(hhmm, mins)=>{const [h,m]=hhmm.split(':').map(Number);const dt=new Date();dt.setHours(h);dt.setMinutes(m+mins);return dt.toTimeString().slice(0,5)};
  const ceilTo15=(date)=>{const ms=15*60*1000;return new Date(Math.ceil(date.getTime()/ms)*ms)};
  const uid=()=>Math.random().toString(36).slice(2,9);
  const isMobile=()=>window.matchMedia('(max-width:768px)').matches; // 768px未満のみモバイル扱い（週ビュー維持）
  const getWeekRange=(base)=>{const monday=new Date(base);monday.setDate(base.getDate()-((base.getDay()+6)%7));monday.setHours(0,0,0,0);return {monday,nextMonday:new Date(monday.getTime()+7*24*60*60*1000)}};

  // 高コントラストカラーパレット
  const STAFF_PALETTE = ['#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd','#8c564b','#e377c2','#7f7f7f','#bcbd22','#17becf','#003f5c','#58508d','#bc5090','#ff6361','#ffa600'];
  function colorByStaffName(name){ let h=0; for(let i=0;i<name.length;i++) h=(h*33+name.charCodeAt(i))>>>0; return STAFF_PALETTE[h % STAFF_PALETTE.length]; }
  function parseTitleStaff(ev){ const t=ev?.title||''; const ep=ev?.extendedProps||{}; if(ep.staffName) return ep.staffName; const m=/（(.+?)）\s*$/.exec(t); return m?m[1]:''; }
  function parseTitleUser(ev){ const m=/^(.*)（/.exec(ev.title||''); return m?m[1]:ev.title||''; }

  // ===== モーダル =====
  function armAndMountModal(html){
    const overlay=document.createElement('div'); overlay.className='overlay';
    const box=document.createElement('div'); box.className='modal'; box.innerHTML=html;
    document.body.appendChild(overlay); document.body.appendChild(box);
    let armed=false; setTimeout(()=>armed=true,220);
    const close=()=>{ overlay.remove(); box.remove(); };
    overlay.addEventListener('click', e=>{ if(e.target===overlay && armed) close(); });
    window.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); }, {once:true});
    return {overlay,box,close};
  }

  // ===== 住所スコア + 非常勤ボーナス =====
  const wardRe = /(大阪市[^区]*区)/;
  function splitAddr(a){
    const s=(a||'').trim().replace(/\s+/g,'');
    const ward=(s.match(wardRe)||[])[1]||'';
    const town=(s.match(/区(.+?)(\d+丁目|\d+-|[0-9]|$)/)||[])[1]||'';
    const chome=(s.match(/(\d+)丁目/)||[])[1]||'';
    return {ward,town,chome: chome?Number(chome):null};
  }
  function proximityScore(prevAddr,nextAddr, staffType){
    if(!prevAddr||!nextAddr) return staffType==='PT'?10:0;
    const a=splitAddr(prevAddr), b=splitAddr(nextAddr);
    let score=0;
    if(a.ward && b.ward && a.ward===b.ward){
      if(a.town && b.town && a.town===b.town){
        if(a.chome && b.chome){
          if(a.chome===b.chome) score+=100;
          else if(Math.abs(a.chome-b.chome)===1) score+=75;
          else score+=50;
        }else{ score+=50; }
      }else{
        const tail = (x)=> (x||'').slice(-2);
        if(tail(a.town) && tail(a.town)===tail(b.town)) score+=30;
        else score+=20;
      }
    }
    if(staffType==='PT') score+=10;
    return score;
  }

  // ===== デモの初期データ（スタッフ・利用者・パターンなど） =====
  let office = { address:'（デモ）大阪市中央区架空町 1-2-3' };
  let staff = [
    {id:uid(),name:'青木',type:'PT',ngUserIds:[]},
    {id:uid(),name:'井上',type:'PT',ngUserIds:[]},
    {id:uid(),name:'上田',type:'FT',ngUserIds:[]},
    {id:uid(),name:'大谷',type:'FT',ngUserIds:[]},
    {id:uid(),name:'川端',type:'PT',ngUserIds:[]},
    {id:uid(),name:'木村',type:'FT',ngUserIds:[]},
    {id:uid(),name:'斎藤',type:'PT',ngUserIds:[]},
    {id:uid(),name:'鈴木',type:'FT',ngUserIds:[]},
    {id:uid(),name:'高橋',type:'PT',ngUserIds:[]},
    {id:uid(),name:'藤田',type:'FT',ngUserIds:[]}
  ];
  let shifts = staff.map(s=>({id:uid(),staffId:s.id,days:['月','火','水','木','金','土','日'],start:'09:00',end:'18:00'}));

  const wards=['中央区','北区','西区','天王寺区','浪速区','福島区','此花区','港区','大正区','西成区','阿倍野区','東住吉区'];
  const towns=['桜川','幸町','南堀江','新町','上本町','空堀町','空清町','松屋町','島之内','塩草','元町','敷津','稲荷','恵比寿町','中之島','野田','玉川','福島','鷺洲','此花町','梅田','堂島','天満'];
  function fakeAddr(){ const w=wards[Math.floor(Math.random()*wards.length)], t=towns[Math.floor(Math.random()*towns.length)], ch=Math.ceil(Math.random()*5), ban=Math.ceil(Math.random()*20), go=Math.ceil(Math.random()*20); return `大阪市${w}${t}${ch}丁目 ${ban}-${go}`; }
  function fakeName(i){ const last=['田中','山田','佐藤','鈴木','高橋','伊藤','渡辺','小林','中村','加藤','吉田','山本','井上','石井','木村','林','清水','池田','橋本','阿部','森','西村','福田','太田','松本','藤田','岡田','中島','中川','前田','後藤','長谷川','石田','小野','野口','金子','内田','川口','村上','酒井']; const first=['花子','太郎','健太','美咲','直樹','舞','亮介','さくら','悠斗','結衣','颯太','陽菜','蓮','葵','美月','智也','恵','香織','大輔','千尋','悠','潤','杏奈','優斗','健','茜','陽子','真央','遥','怜奈','慧','圭','渚','修','郁美','航','栞','徹','詩織','奈緒']; return last[i % last.length] + ' ' + first[i % first.length]; }
  let users=[]; for(let i=0;i<80;i++){ users.push({id:uid(),name:fakeName(i),duration:(i%3===0?90:(i%2===0?60:30)),address:fakeAddr()}); }

  const timeBuckets = ['15:00','14:30','14:00','13:30','16:00','10:00','11:00','12:00'];
  const weekDays=['月','火','水','木','金','土','日'];
  let patterns=[];
  users.forEach((u,i)=>{ const wd = weekDays[(i*2)%7]; const wd2 = (i%5===0)? weekDays[(i*2+3)%7] : null; const t1 = timeBuckets[Math.min(timeBuckets.length-1, Math.floor(i*5/timeBuckets.length)%timeBuckets.length)]; patterns.push({id:uid(),userId:u.id,time:t1,days:[wd],active:true}); if(wd2){ const t2 = timeBuckets[Math.min(timeBuckets.length-1, Math.floor((i+17)*5/timeBuckets.length)%timeBuckets.length)]; patterns.push({id:uid(),userId:u.id,time:t2,days:[wd2],active:true}); } });

  // イベント：メモリ + 「新規追加のみ」ローカル保存
  let events=[];
  const saveNewEventsOnly = ()=>{ try{ localStorage.setItem(EVENTS_KEY, JSON.stringify(events)); }catch(e){} };
  const loadSavedNewEvents = ()=>{ try{ const raw = localStorage.getItem(EVENTS_KEY); if(raw){ const list = JSON.parse(raw)||[]; if(Array.isArray(list)) events = list; } }catch(e){} };

  // ====== DOM参照 ======
  const el={
    officeAddress:document.getElementById('officeAddress'),
    btnSaveOffice:document.getElementById('btnSaveOffice'),
    officeInfo:document.getElementById('officeInfo'),

    staffName:document.getElementById('staffName'), staffType:document.getElementById('staffType'), addStaff:document.getElementById('addStaff'), staffList:document.getElementById('staffList'),
    userName:document.getElementById('userName'), userDuration:document.getElementById('userDuration'), addUser:document.getElementById('addUser'), userList:document.getElementById('userList'), userAddress:document.getElementById('userAddress'),
    patternUser:document.getElementById('patternUser'), patternDays:document.getElementById('patternDays'), patternTime:document.getElementById('patternTime'), addPattern:document.getElementById('addPattern'), patternList:document.getElementById('patternList'),
    shiftStaff:document.getElementById('shiftStaff'), shiftDays:document.getElementById('shiftDays'), shiftStart:document.getElementById('shiftStart'), shiftEnd:document.getElementById('shiftEnd'), addShift:document.getElementById('addShift'), shiftList:document.getElementById('shiftList'),
    btnAutoAssignBottom:document.getElementById('btnAutoAssignBottom'), btnResetWeek:document.getElementById('btnResetWeek'),
    calendarHost:document.getElementById('calendar'),
    btnPrintCurrentA4:document.getElementById('btnPrintCurrentA4'),
    btnToggleSidebar:document.getElementById('btnToggleSidebar'),
    btnViewToggle:document.getElementById('btnViewToggle'),
    btnHelp:document.getElementById('btnHelp'),
    ngStaff:document.getElementById('ngStaff'), ngUsers:document.getElementById('ngUsers'), btnAddNG:document.getElementById('btnAddNG'),
    staffBoard:document.getElementById('staffBoard'),
    sbControls:document.getElementById('staffBoardControls'), sbPrev:document.getElementById('sbPrev'), sbNext:document.getElementById('sbNext'), sbDate:document.getElementById('sbDate'),
    printView:document.getElementById('printView')
  };

  // ====== リスト描画 ======
  function sortStaffForView(a,b){ if(a.type!==b.type) return a.type==='FT'?-1:1; return (a.name||'').localeCompare(b.name||'','ja'); }
  const hydrateSelects=()=>{
    const staffSorted=[...staff].sort(sortStaffForView);
    el.shiftStaff.innerHTML=''; staffSorted.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=s.name; el.shiftStaff.appendChild(o); });
    el.ngStaff.innerHTML=''; staffSorted.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=`${s.name}（${s.type==='PT'?'非常勤':'常勤'}）`; el.ngStaff.appendChild(o); });

    const usersSorted=[...users].sort((a,b)=> (a.name||'').localeCompare(b.name||'','ja'));
    el.patternUser.innerHTML=''; usersSorted.forEach(u=>{ const o=document.createElement('option'); o.value=u.id; o.textContent=u.name; el.patternUser.appendChild(o); });

    el.ngUsers.innerHTML=''; usersSorted.forEach(u=>{ const lab=document.createElement('label'); lab.className='chip'; lab.innerHTML=`<input type="checkbox" value="${u.id}"> ${u.name}`; el.ngUsers.appendChild(lab); });

    el.ngStaff.addEventListener('change', ()=>{
      const sid=el.ngStaff.value; const st=staff.find(x=>x.id===sid);
      el.ngUsers.querySelectorAll('input[type="checkbox"]').forEach(ch=>{
        ch.checked = !!(st && (st.ngUserIds||[]).includes(ch.value));
      });
    });
  };
  const renderStaff=()=>{
    const staffSorted=[...staff].sort(sortStaffForView);
    el.staffList.innerHTML='';
    staffSorted.forEach(s=>{
      const ngNames=(s.ngUserIds||[]).map(id=>users.find(u=>u.id===id)?.name).filter(Boolean);
      const ngText=ngNames.length? `｜NG: ${ngNames.join('・')}` : '';
      el.staffList.innerHTML+=`
        <span class='chip'>
          ${s.name}（${s.type==='PT'?'非常勤':'常勤'}） ${ngText}
          <button class='ghost' disabled>編集（デモ）</button>
          <button class='danger' disabled>削除（デモ）</button>
        </span>`;
    });
  };
  const renderUsers=()=>{
    const usersSorted=[...users].sort((a,b)=> (a.name||'').localeCompare(b.name||'','ja'));
    el.userList.innerHTML='';
    usersSorted.forEach(u=>{
      const addr=u.address||'(住所なし)';
      el.userList.innerHTML+=`
        <span class='chip'>
          ${u.name}（${u.duration||60}分） ｜ 住所：${addr}
          <button class='ghost' disabled>編集（デモ）</button>
          <button class='danger' disabled>削除（デモ）</button>
        </span>`;
    });
  };
  const renderPatterns=()=>{ 
    el.patternList.innerHTML='';
    patterns.forEach(p=>{
      const u=users.find(x=>x.id===p.userId);
      el.patternList.innerHTML+=`
      <span class='chip'>
        ${u?u.name:'不明'}：${(p.days||[]).join('・')} ${p.time||''}
        <button class='ghost' disabled>編集（デモ）</button>
        <button class='danger' disabled>削除（デモ）</button>
      </span>`;
    });
  };
  const renderShifts=()=>{ 
    el.shiftList.innerHTML='';
    shifts.forEach(s=>{
      const stf=staff.find(x=>x.id===s.staffId);
      el.shiftList.innerHTML+=`
        <span class='chip'>
          ${stf?stf.name:'不明'}：${s.days.join('・')} ${s.start}〜${s.end}
          <button class='ghost' disabled>編集（デモ）</button>
          <button class='danger' disabled>削除（デモ）</button>
        </span>`;
    });
  };
  const renderOffice=()=>{ el.officeAddress.value = office.address||''; el.officeInfo.textContent = 'デモ用：ローカル保存は行いません'; };
  const renderAll=()=>{ hydrateSelects(); renderStaff(); renderUsers(); renderPatterns(); renderShifts(); renderOffice(); };

  // ====== カレンダー（標準） ======
  const calendar=new FullCalendar.Calendar(el.calendarHost,{
    timeZone:'local',
    headerToolbar: {left:'prev,next today',center:'title',right:'timeGridWeek,timeGridDay'}, // 週ビューボタン復活
    initialView: isMobile()? 'timeGridDay' : 'timeGridWeek', // PCは週
    firstDay:1, locale:'ja', height:'auto',
    slotMinTime:'09:00', slotMaxTime:'18:00',
    expandRows:true, stickyHeaderDates:true,
    editable:true, eventOverlap:true, slotEventOverlap:true, nowIndicator:true,
    slotDuration:'00:15:00', snapDuration:'00:15:00', allDaySlot:false,
    events:(info,success)=>{ success((events||[]).map(e=>({...e}))); },
    eventDidMount:(info)=>{
      const sn = parseTitleStaff(info.event);
      info.event.setExtendedProp('staffName', sn);
      const col=colorByStaffName(sn);
      info.event.setProp('backgroundColor', col);
      info.event.setProp('borderColor', 'var(--event-border)');
      info.el.style.background=col; info.el.style.borderColor='var(--event-border)'; info.el.style.color='#111';
    },
    eventDrop:(info)=>{ snapTo15(info.event); syncStaffBoardIfOpen(); /* 保存しない */ },
    eventResize:(info)=>{ snapTo15(info.event); syncStaffBoardIfOpen(); /* 保存しない */ },
    dateClick:(info)=>{ openCreateEventDialog(new Date(info.dateStr)); },
    eventClick:(info)=>{ openEditorById(info.event.id); }
  });
  function snapTo15(ev){
    const s=ceilTo15(ev.start); const e=ceilTo15(ev.end);
    ev.setDates(s,e,{maintainDuration:false});
    const sn = parseTitleStaff(ev);
    ev.setExtendedProp('staffName', sn);
    ev.setProp('backgroundColor', colorByStaffName(sn));
    ev.setProp('borderColor', 'var(--event-border)');
    // 表示のみ更新（保存なし）
    events = calendar.getEvents().map(ev=>({ id:ev.id||uid(), title:ev.title, start:ev.start.toISOString(), end:ev.end.toISOString(), extendedProps:{...(ev.extendedProps||{})}, backgroundColor: ev.backgroundColor, borderColor: ev.borderColor }));
  }

  // ====== 新規作成（この操作だけ保存する） =====
  function openCreateEventDialog(defaultStart){
    const def = new Date(defaultStart||Date.now());
    const ymd = fmtDateLocal(def);
    const hhmm = def.toTimeString().slice(0,5);
    const staffOptions = [...staff].sort(sortStaffForView).map(s=>`<option value="${s.name}">${s.name}（${s.type==='PT'?'非常勤':'常勤'}）</option>`).join('');
    const userOptions = [...users].sort((a,b)=> (a.name||'').localeCompare(b.name||'','ja')).map(u=>`<option value="${u.name}">${u.name}</option>`).join('');
    const {box,close} = armAndMountModal(`
      <h3>訪問イベント追加</h3>
      <p style="color:#666;margin:.2rem 0 .6rem">※デモ版は<strong>新規追加のみ保存</strong>します。他の操作は表示のみです。</p>
      <div class="row">
        <div style="flex:1"><label>日付</label><input id="ceDate" type="date" value="${ymd}"></div>
        <div style="flex:1"><label>開始</label><input id="ceStart" type="time" value="${hhmm}"></div>
        <div style="flex:1"><label>時間（分）</label><select id="ceDur"><option>30</option><option selected>60</option><option>90</option></select></div>
      </div>
      <div class="row">
        <div style="flex:1"><label>スタッフ（選択 or 手入力）</label><select id="ceStaffSel"><option value="">選択しない</option>${staffOptions}</select><input id="ceStaffTxt" placeholder="手入力：スタッフ名"></div>
        <div style="flex:1"><label>利用者（選択 or 手入力）</label><select id="ceUserSel"><option value="">選択しない</option>${userOptions}</select><input id="ceUserTxt" placeholder="手入力：利用者名"></div>
      </div>
      <div class="actions">
        <button class="btn primary" id="ceSave">追加して保存</button>
        <button class="btn ghost" id="ceClose">閉じる</button>
      </div>
    `);
    box.querySelector('#ceClose').onclick=close;
    box.querySelector('#ceSave').onclick=()=>{
      const date = (box.querySelector('#ceDate').value)||ymd;
      const start = (box.querySelector('#ceStart').value)||hhmm;
      const dur = parseInt(box.querySelector('#ceDur').value)||60;
      const stf = (box.querySelector('#ceStaffSel').value)|| (box.querySelector('#ceStaffTxt').value||'').trim();
      const usr = (box.querySelector('#ceUserSel').value)|| (box.querySelector('#ceUserTxt').value||'').trim();
      if(!stf || !usr) return alert('スタッフと利用者を入力または選択してください');
      const endStr = addMinStr(start, dur);
      const col=colorByStaffName(stf);
      events.push({
        id: uid(),
        title:`${usr}（${stf}）`,
        start:`${date}T${start}:00`,
        end:`${date}T${endStr}:00`,
        extendedProps:{staffName:stf},
        backgroundColor:col, borderColor:'var(--event-border)'
      });
      // 新規追加は保存
      saveNewEventsOnly();
      calendar.removeAllEvents(); calendar.addEventSource(events);
      close();
    };
  }

  // ==== イベント編集（デモ：保存しない） ====
  function openEditorById(eventId){
    const rec = events.find(e=>e.id===eventId);
    if(!rec) return;
    const dStart = new Date(rec.start);
    const user=parseTitleUser(rec); const staffName=parseTitleStaff(rec);
    const dur = Math.round(((new Date(rec.end))-dStart)/60000) || 60;
    const staffOptions = [...staff].sort(sortStaffForView).map(s=>`<option ${s.name===staffName?'selected':''} value="${s.name}">${s.name}（${s.type==='PT'?'非常勤':'常勤'}）</option>`).join('');
    const userOptions = [...users].sort((a,b)=> (a.name||'').localeCompare(b.name||'','ja'))
      .map(u=>`<option ${u.name===user?'selected':''} value="${u.name}">${u.name}</option>`).join('');
    const {box,close} = armAndMountModal(`
      <h3>訪問プレビュー（デモ）</h3>
      <div class="row">
        <div style="flex:1"><label>日付</label><input id="pvDate" type="date" value="${fmtDateLocal(dStart)}"></div>
        <div style="flex:1"><label>開始</label><input id="pvStart" type="time" value="${dStart.toTimeString().slice(0,5)}"></div>
        <div style="flex:1"><label>時間（分）</label>
          <select id="pvDur"><option value="30" ${dur===30?'selected':''}>30</option><option value="60" ${dur===60?'selected':''}>60</option><option value="90" ${dur===90?'selected':''}>90</option></select>
        </div>
      </div>
      <div class="row" style="margin-top:6px">
        <div style="flex:1">
          <label>スタッフ</label>
          <select id="pvStaffSel"><option value="">選択しない</option>${staffOptions}</select>
          <input id="pvStaffTxt" placeholder="手入力可" value="${staffName}">
        </div>
        <div style="flex:1">
          <label>利用者</label>
          <select id="pvUserSel"><option value="">選択しない</option>${userOptions}</select>
          <input id="pvUserTxt" placeholder="手入力可" value="${user}">
        </div>
      </div>
      <div class="actions">
        <button id="pvSave" class="btn primary">表示に反映（保存しません）</button>
        <button id="pvDelete" class="btn danger">削除（保存しません）</button>
        <button id="pvClose" class="btn ghost">閉じる</button>
      </div>
      <div class="muted" style="margin-top:.4rem">※デモ版のため保存は行われません（画面表示のみ更新）。</div>
    `);
    box.querySelector('#pvClose').onclick=close;
    box.querySelector('#pvDelete').onclick=()=>{
      events = events.filter(e=>e.id!==eventId);
      calendar.removeAllEvents(); calendar.addEventSource(events);
      close();
    };
    box.querySelector('#pvSave').onclick=()=>{
      const date = box.querySelector('#pvDate').value||fmtDateLocal(dStart);
      const st = box.querySelector('#pvStart').value || '09:00';
      const ndur = parseInt(box.querySelector('#pvDur').value)||60;
      const stf = (box.querySelector('#pvStaffSel').value)|| (box.querySelector('#pvStaffTxt').value||'').trim() || staffName;
      const usr = (box.querySelector('#pvUserSel').value)|| (box.querySelector('#pvUserTxt').value||'').trim() || user;
      const endStr = addMinStr(st, ndur);
      rec.title = `${usr}（${stf}）`;
      rec.start = `${date}T${st}:00`;
      rec.end   = `${date}T${endStr}:00`;
      rec.extendedProps = {...(rec.extendedProps||{}), staffName: stf};
      rec.backgroundColor = colorByStaffName(stf);
      rec.borderColor = 'var(--event-border)';
      calendar.removeAllEvents(); calendar.addEventSource(events);
      close();
    };
  }

  // ====== 自動割当（非常勤優先 → 住所近接 → 極力均等化） 表示のみ ======
  function lastAddressOfStaffOnDay(staffName, dayDate, untilHHMM){
    const dayStr=fmtDateLocal(dayDate);
    const until = new Date(`${dayStr}T${untilHHMM}:00`);
    let lastEv=null;
    (events||[]).forEach(ev=>{
      const sn=parseTitleStaff(ev); if(sn!==staffName) return;
      const s=new Date(ev.start);
      if(fmtDateLocal(s)!==dayStr) return;
      if(s < until && (!lastEv || s>new Date(lastEv.start))) lastEv=ev;
    });
    if(lastEv){
      const uName=parseTitleUser(lastEv);
      const u = users.find(x=>x.name===uName);
      return u?.address || office.address || '';
    }
    return office.address || '';
  }
  function countAssignedForWeek(staffName, monday, nextMonday){
    let c=0;(events||[]).forEach(ev=>{ const sn=parseTitleStaff(ev); if(sn===staffName){ const s=new Date(ev.start); if(s>=monday && s<nextMonday) c++; } }); return c;
  }
  function autoAssignWeek(){
    const rng = getWeekRange(calendar.getDate());
    const monday = rng.monday; const nextMonday = rng.nextMonday;
    const inWeek = (iso)=>{ const d=new Date(iso); return d>=monday && d<nextMonday; };
    events = (events||[]).filter(ev=> !inWeek(ev.start)); // 今週分を一旦クリア（表示用）

    const hasShiftLocal = (stfId, dayLabel, startStr, endStr)=>{
      const sh = shifts.filter(x=>x.staffId===stfId && x.days.includes(dayLabel));
      return sh.some(x=> x.start<=startStr && x.end>=endStr );
    };
    const weekdayLabel=(date)=>{ const idx=(date.getDay()+6)%7; return dayNamesJP[idx]; };

    const active = patterns.filter(p => p.active !== false);
    let placed=0;

    for(const p of active){
      const u = users.find(x=>x.id===p.userId);
      if(!u) continue;
      for(const d of (p.days||[])){
        const idx = dayNamesJP.indexOf(d); if(idx<0) continue;
        const day = new Date(monday); day.setDate(monday.getDate()+idx);
        const st = p.time; const en = addMinStr(st, u.duration);
        const startISO = `${fmtDateLocal(day)}T${st}:00`;
        const endISO   = `${fmtDateLocal(day)}T${en}:00`;
        const dayLabel = weekdayLabel(day);

        const candidates = staff.filter(s=> hasShiftLocal(s.id,dayLabel,st,en) && !(s.ngUserIds||[]).includes(u.id));

        const placeable=(cand)=>{
          const sn=cand.name; const ns=new Date(startISO), ne=new Date(endISO);
          const clash = (events||[]).some(ev=>{
            const name=parseTitleStaff(ev);
            if(name!==sn) return false;
            const s=new Date(ev.start), e=new Date(ev.end||ev.start);
            return !(e<=ns || s>=ne);
          });
          return !clash;
        };

        const scored = candidates.map(c=>{
          const currentAddr = lastAddressOfStaffOnDay(c.name, day, st) || office.address || '';
          const score = proximityScore(currentAddr, u.address||'', c.type);
          const weeklyCount = countAssignedForWeek(c.name, monday, nextMonday);
          return {c, score, weeklyCount};
        }).filter(x=> placeable(x.c));

        if(scored.length===0) continue;
        scored.sort((a,b)=> (b.score - a.score) || (a.weeklyCount - b.weeklyCount) || a.c.name.localeCompare(b.c.name,'ja'));
        const picked = scored[0].c;

        const col=colorByStaffName(picked.name);
        events.push({ id: uid(), title:`${u.name}（${picked.name}）`, start:startISO, end:endISO, extendedProps:{staffName:picked.name}, backgroundColor:col, borderColor:'var(--event-border)' });
        placed++;
      }
    }
    calendar.removeAllEvents(); calendar.addEventSource(events);
    if(viewMode==='staffBoard') renderStaffBoard();
    alert(`自動割当（デモ）完了：配置 ${placed} 件（保存はしません）`);
  }

  // ====== スタッフ別ボード ======
  let viewMode='standard';
  let staffBoardDate = new Date();
  let staffCalendars=[];
  function renderStaffBoard(){
    staffCalendars.forEach(sc=> sc.cal.destroy());
    staffCalendars=[];
    document.getElementById('staffBoard').innerHTML='';

    const startDay=new Date(staffBoardDate); startDay.setHours(0,0,0,0);
    const endDay=new Date(startDay); endDay.setDate(endDay.getDate()+1);

    staff.forEach(s=>{
      const col=document.createElement('div'); col.className='col';
      col.innerHTML=`<h4>${s.name}（${s.type==='PT'?'非常勤':'常勤'}）</h4><div class="calHost"></div>`;
      document.getElementById('staffBoard').appendChild(col);
      const host=col.querySelector('.calHost');

      const cal=new FullCalendar.Calendar(host,{
        timeZone:'local', headerToolbar:false, initialView:'timeGridDay',
        initialDate:startDay, visibleRange:{ start:startDay, end:endDay },
        firstDay:1, locale:'ja', height:600, slotMinTime:'09:00', slotMaxTime:'18:00',
        expandRows:true, nowIndicator:true, allDaySlot:false,
        dayHeaderFormat:{ weekday:'short', month:'numeric', day:'numeric' },
        editable:true, eventOverlap:true, slotEventOverlap:true,
        events:(info,success)=>{
          const list=(events||[]).filter(e=>{
            const sn=parseTitleStaff(e); const d=new Date(e.start);
            return sn===s.name && d>=startDay && d<endDay;
          }).map(e=>({...e}));
          success(list);
        },
        eventDidMount:(info)=>{
          const colr=colorByStaffName(s.name);
          info.el.style.background=colr; info.el.style.borderColor='var(--event-border)';
          info.el.style.color='#111';
        },
        eventDrop:(info)=>{
          const ev = info.event;
          const idx = events.findIndex(x=>x.id===ev.id);
          if(idx>=0){
            events[idx].start = ev.start.toISOString();
            events[idx].end   = ev.end.toISOString();
            calendar.removeAllEvents(); calendar.addEventSource(events); // 保存しない
          }
        },
        eventResize:(info)=>{
          const ev = info.event;
          const idx = events.findIndex(x=>x.id===ev.id);
          if(idx>=0){
            events[idx].start = ev.start.toISOString();
            events[idx].end   = ev.end.toISOString();
            calendar.removeAllEvents(); calendar.addEventSource(events); // 保存しない
          }
        },
        dateClick:(info)=>{ openCreateEventDialog(new Date(info.dateStr)); },
        eventClick:(info)=>{ openEditorById(info.event.id); }
      });
      cal.render();
      staffCalendars.push({id:s.id, cal});
    });
    document.getElementById('sbDate').value = fmtDateLocal(startDay);
  }
  function switchViewMode(mode){
    viewMode=mode;
    if(mode==='standard'){
      document.getElementById('calendar').style.display='';
      document.getElementById('staffBoard').classList.remove('active');
      document.getElementById('staffBoardControls').classList.remove('active');
      document.getElementById('btnViewToggle').textContent='表示：標準';
      calendar.updateSize();
    }else{
      document.getElementById('calendar').style.display='none';
      document.getElementById('staffBoard').classList.add('active');
      document.getElementById('staffBoardControls').classList.add('active');
      document.getElementById('btnViewToggle').textContent='表示：スタッフ別';
      staffBoardDate = new Date(calendar.getDate());
      renderStaffBoard();
    }
  }
  const syncStaffBoardIfOpen=()=>{ if(viewMode==='staffBoard') renderStaffBoard(); };

  // ====== 印刷（デモ案内のみ） ======
  function printCurrentView(){ alert('デモ版では印刷はご利用いただけません。製品版でご提供します。'); }

  // ====== もっと見る 安定化 ======
  function setupCollapsible(listEl){
    if(!listEl) return;
    if(listEl.dataset.collapsibleInit === '1'){
      const btn = listEl.nextElementSibling;
      if(btn && btn.classList && btn.classList.contains('show-more-btn') && !btn.dataset.bound){
        btn.dataset.bound = '1';
        btn.addEventListener('click', ()=>{ listEl.classList.toggle('list-collapsed'); btn.textContent = listEl.classList.contains('list-collapsed') ? 'もっと見る' : '閉じる'; setTimeout(()=>calendar.updateSize(), 0); });
      }
      return;
    }
    listEl.dataset.collapsibleInit = '1';
    listEl.classList.add('list-collapsed');
    let btn = listEl.nextElementSibling;
    if(!(btn && btn.classList && btn.classList.contains('show-more-btn'))){
      btn = document.createElement('button'); btn.className='show-more-btn'; listEl.after(btn);
    }
    btn.textContent = 'もっと見る';
    btn.style.display = 'block';
    btn.dataset.bound = '1';
    btn.addEventListener('click', ()=>{ listEl.classList.toggle('list-collapsed'); btn.textContent = listEl.classList.contains('list-collapsed') ? 'もっと見る' : '閉じる'; setTimeout(()=>calendar.updateSize(), 0); });
    new MutationObserver(()=>{ btn.textContent = listEl.classList.contains('list-collapsed') ? 'もっと見る' : '閉じる'; }).observe(listEl, {childList:true});
  }

  // ====== ヘルプ / 商品説明 ======
  document.getElementById('btnHelp').addEventListener('click', ()=>{
    const {box,close}=armAndMountModal(`
      <h3>ヘルプ / 商品説明（デモ版）</h3>
      <p><strong>このデモは、ボタンひとつで訪問スケジュールが自動作成できる体験版</strong>です。<br>
      <strong>新規イベントの追加のみ保存</strong>されます。自動割当・ドラッグ移動・編集は<strong>表示のみ</strong>です。</p>
      <h4>使い方</h4>
      <ol>
        <li>左の「自動割当（デモ）」を押すと、1週間分を自動配置します。</li>
        <li>カレンダーをクリックすると<strong>新規イベント追加</strong>（こちらのみ保存）できます。</li>
        <li>配置後はドラッグ/リサイズ/クリック編集で微調整（保存はされません）。</li>
      </ol>
      <h4>自動割当のルール（デモ）</h4>
      <ul>
        <li>まず<strong>非常勤を優先</strong>（加点）。</li>
        <li>つぎに<strong>住所の近さ</strong>：同一丁目 ＞ 隣接丁目 ＞ 同一町名 ＞ 隣接町名 ＞ 同一区。</li>
        <li>最後に<strong>極力均等化</strong>（偏り抑制）。</li>
      </ul>
      <h4>料金・納期</h4>
      <ul>
        <li><strong>買い切り：20,000円〜</strong>（要件により変動）</li>
        <li>アップデートやデータ入力代行は<strong>応相談</strong></li>
        <li>簡易構成なら<strong>約2週間</strong>で納品可能</li>
      </ul>
      <h4>お問い合わせ</h4>
      <ul>
        <li>Instagram：<a href="https://instagram.com/yasashiihp" target="_blank">@yasashiihp</a></li>
        <li>LINE / メール / 電話：<a href="https://crzydn.github.io/yasashiiHP/" target="_blank">やさしいHP 公式サイト</a></li>
      </ul>
      <div class="actions">
        <button class="btn primary" id="goAssign">今すぐ 自動割当 を試す</button>
        <button class="btn ghost" id="helpClose">閉じる</button>
      </div>
    `);
    box.querySelector('#helpClose').onclick=close;
    box.querySelector('#goAssign').onclick=()=>{ close(); autoAssignWeek(); };
  });

  // ====== イベントハンドラ ======
  document.getElementById('btnViewToggle').addEventListener('click', ()=>{ switchViewMode(viewMode==='standard'?'staffBoard':'standard'); });
  document.getElementById('btnPrintCurrentA4').addEventListener('click', ()=> alert('デモ版では印刷はご利用いただけません。製品版でご提供します。'));
  document.getElementById('btnToggleSidebar').addEventListener('click', ()=>{ document.body.classList.toggle('sidebar-collapsed'); setTimeout(()=> calendar.updateSize(), 0); if(viewMode === 'staffBoard') renderStaffBoard(); });

  document.getElementById('btnSaveOffice').addEventListener('click', ()=>{ alert('デモ版では保存できません。製品版でご提供します。'); });
  document.getElementById('addStaff').addEventListener('click', ()=>{ alert('デモ版では追加できません。製品版でご提供します。'); });
  document.getElementById('addUser').addEventListener('click', ()=>{ alert('デモ版では追加できません。製品版でご提供します。'); });
  document.getElementById('addPattern').addEventListener('click', ()=>{ alert('デモ版では追加できません。製品版でご提供します。'); });
  document.getElementById('addShift').addEventListener('click', ()=>{ alert('デモ版では追加できません。製品版でご提供します。'); });
  document.getElementById('btnAddNG').addEventListener('click', ()=>{ alert('デモ版ではNG登録できません。製品版でご提供します。'); });

  document.getElementById('btnAutoAssignBottom').addEventListener('click', autoAssignWeek);

  document.getElementById('sbPrev').addEventListener('click',()=>{ staffBoardDate.setDate(staffBoardDate.getDate()-1); renderStaffBoard(); });
  document.getElementById('sbNext').addEventListener('click',()=>{ staffBoardDate.setDate(staffBoardDate.getDate()+1); renderStaffBoard(); });
  document.getElementById('sbDate').addEventListener('change',(e)=>{ const v=e.target.value; if(v){ staffBoardDate=new Date(v+'T00:00:00'); renderStaffBoard(); }});

  document.getElementById('btnResetWeek').addEventListener('click', ()=>{
    const {monday,nextMonday}=getWeekRange(calendar.getDate());
    // 今週分イベントを削除（メモリ）
    calendar.getEvents().forEach(ev=>{ if(ev.start>=monday && ev.start<nextMonday) ev.remove(); });
    events = calendar.getEvents().map(ev=>({ id:ev.id||uid(), title:ev.title, start:ev.start.toISOString(), end:ev.end.toISOString(), extendedProps:{...(ev.extendedProps||{})}, backgroundColor: ev.backgroundColor, borderColor: ev.borderColor }));
    // 保存済み（新規追加のみ保存）の中からも今週分を削除
    try{
      const raw=localStorage.getItem(EVENTS_KEY); if(raw){
        const list=(JSON.parse(raw)||[]).filter(ev=> !(new Date(ev.start)>=monday && new Date(ev.start)<nextMonday) );
        localStorage.setItem(EVENTS_KEY, JSON.stringify(list));
      }
    }catch(e){}
    if(viewMode==='staffBoard') renderStaffBoard();
    alert('今週分の表示を消去しました（保存されていた新規追加分も削除）');
  });

  // ====== 初期化 ======
  // 保存されている「新規追加のみ」を読み込み
  loadSavedNewEvents();

  const renderWeekdayChecks=(c)=>{ c.innerHTML=''; dayNamesJP.forEach(d=>{ const w=document.createElement('label'); w.className='chip'; w.innerHTML=`<input type="checkbox" value="${d}"> ${d}`; c.appendChild(w); }); };
  renderWeekdayChecks(document.getElementById('patternDays'));
  renderWeekdayChecks(document.getElementById('shiftDays'));
  renderAll();

  // 折り畳み
  ['staffList','userList','patternList','shiftList'].forEach(id=> { const box=document.getElementById(id); setupCollapsible(box); });

  calendar.render();
});
</script>
</body>
</html>